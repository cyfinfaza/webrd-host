<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>cyhat</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.2/mqttws31.min.js"
		type="text/javascript"></script>
	<link rel="stylesheet" href="https://hx.cy2.me/basicstyle.css">
	<style>
		#theirvideo {
			position: absolute;
			width: 100%;
			height: 100%;
			filter: saturate(1.1);
			transition: 180ms ease;
		}

		#myvideo {
			position: fixed;
			width: 250px;
			top: 8px;
			right: 8px;
			z-index: 5;
			border-radius: 8px;
		}

		#setup {
			position: absolute;
			z-index: 10;
			width: 100%;
			height: 100%;
			display: flex;
			align-items: center;
			justify-content: center;
			background-color: #8888;
		}

		#setup>div {
			padding: 24px;
			background-color: #000;
			border-radius: 16px;
			max-width: 400px;
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		#setup>div>* {
			margin-bottom: 0;
		}

		#connectingText {
			display: none;
		}

		.manyButtonHolder>button {
			margin: 4px;
		}
	</style>
</head>

<body style="margin: 0; width: 100%; height: 100%;">
	<div id="setup">
		<div>
			<p style="font-size: 32px; margin: 0;" id="idText"></p>
			<p>
				First:
				<button class="hoverfancy" onclick="shareMyScreen()">Share Screen</button>
				<!-- <button onclick="startMyVideo()">Camera</button> -->
			</p>
			<p>Then you can type in someone else's ID to connect to them, or you can give them your
				ID, and they will
				connect to you.
			</p>
			<p>
				<input class="hoverfancy" id="idInput" type="text" onkeydown="if(event.keyCode===13)startConnecting()"
					placeholder="Enter ID">
				<button class="hoverfancy" onclick="startConnecting()">Connect</button>
			</p>
			<p id="availableConnections" class="manyButtonHolder">
			</p>
			<p style="margin-top: 16px;" id="connectingText">Attempting P2P connection...</p>
		</div>
	</div>
	<video id="myvideo" controls muted preload="none" autoplay></video>
	<video id="theirvideo" controls muted preload="none" autoplay src="tree.jpg"></video>
</body>
<script>

	const { ipcRenderer, desktopCapturer } = require("electron");
	let myMedia = new MediaStream();

	window.ipcRenderer = ipcRenderer;

	ipcRenderer.on("SET_SOURCE", async (event, sourceId) => {
		console.log("got set source event");
		try {
			const stream = await navigator.mediaDevices.getUserMedia({
				audio: false,
				video: {
					mandatory: {
						chromeMediaSource: "desktop",
						chromeMediaSourceId: sourceId,
					},
				},
			});
			handleStream(stream);
		} catch (e) {
			handleError(e);
		}
	});



	function handleStream(stream) {
		window.stream = stream;
		console.log("stream", stream);
		myMedia = stream;
		shareMyScreen()
	}
	const initialPath = "cyhat/"
	let clientID = "" + parseInt(Math.random() * 10000000);
	let willMessage = new Paho.MQTT.Message(clientID)
	willMessage.destinationName = initialPath + "disconnect"
	document.getElementById('idText').innerHTML = "Your ID: " + clientID;
	let remoteClientID = "0"
	let client;
	let available = [];
	connect();
	function connect() {
		client = new Paho.MQTT.Client("mq02.cy2.me", 443, clientID);
		client.onMessageArrived = onMessageArrived;
		client.onConnectionLost = onFailure;
		deleteNext = false;
		client.connect({
			onSuccess: onConnect,
			// onFailure: document.getElementById("messages").innerHTML += '<span>ERROR: Connection to: ' + host + ' on port: ' + port + ' failed.</span><br/>';
			onFailure: onFailure,
			useSSL: true,
			// willMessage: willMessage,
			// reconnect: true,
		});
	}
	function onFailure() {
		console.log("failure")
		client.connect({
			onSuccess: onConnect,
			onFailure: onFailure,
			useSSL: true,
			willMessage: willMessage
		});
	}
	function onConnect() {
		client.subscribe(initialPath + clientID);
		client.subscribe(initialPath + "disconnect");
		client.subscribe(initialPath + "connect");
		console.log("Subscribed.");
	}
	async function onMessageArrived(message) {
		console.log("rx: " + message.payloadString);
		if (message.destinationName == initialPath + "disconnect") {
			if (message.payloadString == remoteClientID) {
				theirVideoElement.style.transform = "scaleY(0)"
				setInterval(() => {
					window.location.reload()
				}, 360);
			}
		}
		if (message.destinationName == initialPath + "connect") {
			if (message.payloadString != clientID && message.payloadString.length < 8) {
				if (available.length > 3) available.shift()
				available.push('<button class="hoverfancy" onclick="startConnecting(\'' + message.payloadString + '\')">' + message.payloadString + '</button>\n')
			}
			let htmlString = ""
			available.forEach(element => {
				htmlString += element
			});
			document.getElementById('availableConnections').innerHTML = htmlString
		}
		let data = JSON.parse(message.payloadString);
		if (data.type === "setRemoteID") {
			initiate(data.remoteClientID)
		}
		if (data.type === "setOffer") {
			await pc1.setRemoteDescription(data.remoteDesc)
			console.log("Set Remote Description: ", data.remoteDesc)
			let answer = await pc1.createAnswer();
			answer.sdp.replace('useinbandfec=1', 'useinbandfec=1; stereo=1; maxaveragebitrate=510000');
			pc1.setLocalDescription(answer)
			send(JSON.stringify({ 'type': 'setAnswer', 'remoteDesc': answer }))
		}
		if (data.type === "setAnswer") {
			await pc1.setRemoteDescription(data.remoteDesc)
			console.log("Set Remote Description: ", data.remoteDesc)
		}
		if (data.type === "addIceCandidate") {
			await pc1.addIceCandidate(data.iceCandidate)
			console.log("Set Remote Ice Candidate: ", data.iceCandidate)
		}
	}
	function onConnectionLost(responseObject) {
		if (responseObject.errorCode !== 0) {
			console.log("onConnectionLost:" + responseObject.errorMessage);
		}
	}
	function send(messageText) {
		message = new Paho.MQTT.Message(messageText);
		message.destinationName = initialPath + remoteClientID;
		client.send(message);
	}
	let theirMedia = new MediaStream()
	let myVideoElement = document.getElementById('myvideo')
	let theirVideoElement = document.getElementById('theirvideo')
	const blankSrc = new MediaStream()
	myVideoElement.srcObject = blankSrc;
	theirVideoElement.srcObject = blankSrc;
	let pc1;
	const configuration = {
		'iceServers': [
			{ 'urls': 'stun:stun.l.google.com:19302' },
			{
				urls: 'turn:numb.viagenie.ca',
				credential: 'muazkh',
				username: 'webrtc@live.com'
			}]
	}
	async function startMyVideo() {
		myMedia = await navigator.mediaDevices.getUserMedia({
			video: {
				width: { ideal: 1920 },
				height: { ideal: 1080 }
			}
		})
		// myMedia = await navigator.mediaDevices.getDisplayMedia()
		console.log(myMedia)
		myVideoElement.srcObject = myMedia;
	}
	async function shareMyScreen() {
		// myMedia = await desktopCapturer
		// 	.getSources({ types: ["window", "screen"] })
		// 	.then(async (sources) => {
		// 		console.log("got sources");
		// 		for (const source of sources) {
		// 			if (source.name === "Screen 1") {
		// 				return await navigator.mediaDevices.getUserMedia({
		// 					audio: false,
		// 					video: {
		// 						mandatory: {
		// 							chromeMediaSource: "desktop",
		// 							chromeMediaSourceId: source.id,
		// 						},
		// 					},
		// 				});
		// 			}
		// 		}
		// 	});
		console.log(myMedia)
		myVideoElement.srcObject = myMedia;
		connectionAnnouncement = new Paho.MQTT.Message(clientID);
		connectionAnnouncement.destinationName = initialPath + "connect";
		client.send(connectionAnnouncement);
	}
	async function initiate(rcID) {
		remoteClientID = rcID;
		pc1 = new RTCPeerConnection(configuration);
		pc1.onicecandidate = function (e) {
			console.log("PC1 Found Candidate: ", e);
			send(JSON.stringify({ 'type': 'addIceCandidate', 'iceCandidate': e.candidate }))
		}
		pc1.onconnectionstatechange = function (e) {
			console.log("PC1 Connection State Changed: ", e)
		}
		myMedia.getTracks().forEach((track) => {
			pc1.addTrack(track, myMedia);
		});
		pc1.ontrack = function (e) {
			document.getElementById('setup').style.display = "none";
			theirVideoElement.srcObject = theirMedia;
			console.log("PC1 Got Track: ", e);
			theirMedia.addTrack(e.track, theirMedia);
		};
		console.log(pc1)
	}
	let idInput = document.getElementById('idInput')
	async function startConnecting(remoteID = null) {
		var remote
		if (remoteID) remote = remoteID;
		else {
			document.getElementById('connectingText').style.display = "unset";
			remote = idInput.value;
		}
		await initiate(remote)
		let offer = await pc1.createOffer()
		offer.sdp.replace('useinbandfec=1', 'useinbandfec=1; stereo=1; maxaveragebitrate=510000');
		console.log(offer)
		await pc1.setLocalDescription(offer)
		send(JSON.stringify({ 'type': 'setRemoteID', 'remoteClientID': clientID }))
		send(JSON.stringify({ 'type': 'setOffer', 'remoteDesc': offer }))
	}
	// shareMyScreen()
</script>

</html>